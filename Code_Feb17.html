<!-- Code for Haoxue's FYP -->
<!-- Current research goal: investigate the role of attitude in social influence and metacognition -->
<!-- Last updated on Feb 17, 2020 -->
<!-- Difference from Feb 13: add confidence process and remove confidnence rating in calibrate -->

<!-- so messy.. need to change the order of the functions -->

<!DOCTYPE html>
<html>

<head>
    <!-- Load relevant libraries -->
    <title>My experiment</title>
    <script src="jspsych-6.0.5/jspsych.js"></script>
    <script src="jspsych-6.0.5/plugins/jspsych-html-keyboard-response.js"></script>
    <script src="jspsych-6.0.5/plugins/jspsych-image-keyboard-response.js"></script>
    <script src="jspsych-6.0.5/plugins/jspsych-rdk.js"></script>
    <script src="jspsych-6.0.5/plugins/jspsych-survey-likert.js"></script>
    <script src="jspsych-6.0.5/plugins/jspsych-html-slider-response.js"></script>
    <script src="jspsych-6.0.5/plugins/jspsych-image-slider-response.js"></script>
    <script src="jspsych-6.0.5/plugins/jspsych-image-slider-response-adv.js"></script>
    <script src="jspsych-6.0.5/plugins/jspsych-image-keyboard-response.js"></script>
    <!--display image-->
    <script src="https://cdn.jsdelivr.net/npm/jstat@latest/dist/jstat.min.js"></script>
    <!--remember to put https: here-->
    <!-- The following Param using is mostly due to debug convenience -->
    <script src="setParam.js"></script>
    <!--global params should be loaded before the .js which needs them-->
    <script src="calibrate_instruct_demo.js"></script>
    <script src="confidence_instruct_demo.js"></script>
    <script src="joint_instruct_demo.js"></script>

    <script src="advisor_accuracy_instruct_demo.js"></script>
    <script src="attitude_instruct_demo.js"></script>
    <link href="jspsych-6.0.5/css/jspsych.css" rel="stylesheet" type="text/css">
    </link>
</head>

<body>
    <!-- set the background color to grey (for all frames) -->

    <body style="background-color:grey;">
    </body>
    <script>

        // Todo (possible)
        // location of rdk (window.innerWidth vs. window.screen.width)

        /* Create timeline*/
        var timeline = [];

        /* define welcome and farewell message trial */
        var welcome = {
            type: "html-keyboard-response",
            stimulus: "Welcome to the experiment!",
            prompt: "Press any key to continue",
            post_trial_gap: 500
        };

        var end_of_task = {
            type: 'html-keyboard-response',
            stimulus: "<p>This is the end of this task. You can take a rest now.</p>" +
                "<p>Press any key to continue.</p>",
            post_trial_gap: para.post_trial_gap_normal
        }
        var farewell = {
            type: "html-keyboard-response",
            stimulus: "<p>This is the end of the whole experiment. You made it! See you next time!</p>" +
                "<p>Press any key to see your data.</p>",
            post_trial_gap: para.post_trial_gap_normal
        }


        /* define task related trials (rdk, decision, etc) */

        /* define trial with 2 choices and 1 correct choice */
        /* beginning: coherence 0.2 */
        var test_trial_first = {
            type: "rdk",
            post_trial_gap: 0,
            number_of_dots: 200,
            RDK_type: 3,
            choices: jsPsych.timelineVariable('choices'),
            correct_choice: jsPsych.timelineVariable('correct_choice'),
            coherent_direction: jsPsych.timelineVariable('coherent_direction'),
            coherence: 0.2,
            trial_duration: 300, /* if -1, the stimulus will be displayed until a valid response is received*/
            aperture_type: 1,
            response_ends_trial: false, // the trial will not be stopped even if the participant has made a decision early
            move_distance: 3, // analogous to speed. - Question: not sure whether I want to set it so quick
            data: jsPsych.timelineVariable('data'),
            data: { phase: 'first', feature: 'first_coherence' }, // ***** seems that it will cover the one used before... how to deal wih this problem?
            // seem problem happens in the future trials.
            //Todo: add unlimited response time
            //Todo: parameters for caliberation ()
            fixation_cross: true,
            fixation_cross_color: "white",
            border: true,
            border_color: "white",
        };

        var test_trial = {
            type: "rdk",
            post_trial_gap: 0,
            number_of_dots: 200,
            RDK_type: 3,
            choices: jsPsych.timelineVariable('choices'),
            correct_choice: jsPsych.timelineVariable('correct_choice'),
            coherent_direction: jsPsych.timelineVariable('coherent_direction'),
            //coherence: jsPsych.timelineVariable('coherence'),
            coherence: function () {
                var feedback_prev = jsPsych.data.get().last(2).values()[0].feedback;
                var feedback_prev2 = jsPsych.data.get().last(5).values()[0].feedback;
                var state_prev = jsPsych.data.get().last(2).values()[0].state;
                var coherence_prev = jsPsych.data.get().last(3).values()[0].coherence;
                var coherence_now = coherence_prev;
                var phase_prev = jsPsych.data.get().last(3).values()[0].phase;
                if (phase_prev == "first") { // make a special case for the two correct situation
                    if (feedback_prev == "correct" && feedback_prev2 == "correct") {
                        coherence_now = coherence_prev - 0.01;
                    }
                }
                if (feedback_prev == "correct" && state_prev == "second") { // normal situation
                    coherence_now = coherence_prev - 0.01;
                }
                else if (feedback_prev == "wrong") {
                    coherence_now = coherence_prev + 0.01;
                }
                return coherence_now
            },
            trial_duration: 300, /* if -1, the stimulus will be displayed until a valid response is received*/
            aperture_type: 1,
            response_ends_trial: false, // the trial will not be stopped even if the participant has made a decision early
            move_distance: 3, // analogous to speed. - Question: not sure whether I want to set it so quick
            data: jsPsych.timelineVariable('data'),
            data: { phase: 'normal', feature: 'normal_coherence' }, // this kind of adding data works
            fixation_cross: true,
            fixation_cross_color: "white",
            border: true,
            border_color: "white",
        };

        var test_trial_threshold = { // the testing trial with fixed coherence level
            type: "rdk",
            post_trial_gap: 0,
            number_of_dots: 200,
            RDK_type: 3,
            choices: jsPsych.timelineVariable('choices'),
            correct_choice: jsPsych.timelineVariable('correct_choice'),
            coherent_direction: jsPsych.timelineVariable('coherent_direction'),
            coherence: para.threshold, //jsPsych.timelineVariable('coherence'), //jsPsych.data.get().select('threshold').mean(), // values or means?
            trial_duration: 300, /* if -1, the stimulus will be displayed until a valid response is received*/
            aperture_type: 1,
            response_ends_trial: false, // the trial will not be stopped even if the participant has made a decision early
            move_distance: 3, // analogous to speed. - Question: not sure whether I want to set it so quick
            data: jsPsych.timelineVariable('data'),
            // data: { phase: 'threshold' }
            //Todo: add unlimited response time
            fixation_cross: true,
            fixation_cross_color: "white",
            border: true,
            border_color: "white",
            aperture_flexible: true,
        };

        var decision_trial = {
            type: "html-keyboard-response",
            stimulus: function () {
                //var left_key = jsPsych.timelineVariable('choices', true)[0];
                //var right_key = jsPsych.timelineVariable('choices', true)[1];
                //L and R can be changed into pic in the future
                var left = 'L';
                var right = 'R';
                return "<p>" + left + " or " + right + "?</p>"
            },
            choices: jsPsych.timelineVariable('choices'),
            post_trial_gap: 200,
            data: { task: 'decision' },
            on_finish: function (data) {
                if (data.key_press == jsPsych.pluginAPI.convertKeyCharacterToKeyCode(jsPsych.timelineVariable('correct_choice', true))) {
                    data.feedback = 'correct';
                } else {
                    data.feedback = 'wrong';
                }
                var phase_now = jsPsych.data.get().last(2).values()[0].phase; // when we specify things in the on_finish feature, this trial has already FINISHED
                // if phase_prev == "first", 
                if (phase_now == "first") { // caveat: should find a way to list the second one as 
                    data.state = "first"; // a little not precise for the second first trial - but leave it like this now
                }
                else {
                    var phase_prev = jsPsych.data.get().last(5).values()[0].phase;
                    var state_prev = jsPsych.data.get().last(4).values()[0].state;
                    var feedback_prev = jsPsych.data.get().last(4).values()[0].feedback;
                    if (data.feedback == "correct") {
                        if (feedback_prev == "correct" && state_prev == "first" && phase_prev !== "first") {
                            data.state = "second";
                        }
                        else {
                            data.state = "first";
                        }
                    }
                }
            }
        }

        // My question: put the feedback here will it reinforce the confidence?
        /* define feedback */
        var feedback_trial = {
            type: "html-keyboard-response",
            choices: jsPsych.NO_KEYS,
            stimulus: function () {
                var feedback = jsPsych.data.get().last(1).values()[0].feedback; // now needs to be last two because we are tracing back one more
                if (feedback == "correct") {
                    var color = "blue";
                }
                else {
                    var color = "red";
                }
                return "<p> <span style = \"color:" + color + "; font-size: 200%\"><b>" + feedback + "</b></span></p>"
            },
            trial_duration: 500,
            // post_trial_gap: 00,
            data: { task: 'feedback' }
            //Todo: how to send feedback? beep or word?
        };

        var feedback_trial_debug = { // add the coherence output
            type: "html-keyboard-response",
            choices: jsPsych.NO_KEYS,
            stimulus: function () {
                var feedback = jsPsych.data.get().last(1).values()[0].feedback; // has changed num accordingly
                var coherence = jsPsych.data.get().last(2).values()[0].coherence;
                if (feedback == "correct") {
                    var color = "blue";
                }
                else {
                    var color = "red";
                }
                return "<p> <span style = \"color:" + color + "; font-size: 200%\"><b>" + feedback + "</b></span></p>"
                // "<p>coherence level is " + coherence + "</p>"
            },
            trial_duration: 1000,
            post_trial_gap: 200,
            data: { task: 'feedback' }
            //Todo: how to send feedback? beep or word? (currently using words)
        };

        // Todo: change it multiple times? only one opportunity? (currently only one opportunity)

        // show advice and confidence
        var confidence_rating_1_pic = {
            type: "image-slider-response",
            stimulus: 'img/sil_blank.png',
            stimulus_height: function () {
                return window.screen.height / 6
            },
            labels: ['LEFT', 'RIGHT'],
            start: function () {
                return Math.random() * 100
            },
            values: ['100', '80', '60', '60', '80', '100'],
            center: '50',
            vertical_center: true,
            vertical: true,
            slider_width: function () {
                return window.screen.width / 4
            },
        };
        //Todo: make it more beautiful - 1~3 and 3 becomes a variable? - I mean blocks?

        // show advice and confidence
        var confidence_rating_1_adv = {
            type: "image-slider-response-adv",
            stimulus: 'img/sil.png',
            stimulus_height: function () {
                return window.screen.height / 6
            },
            labels: ['LEFT', 'RIGHT'],
            start: function () {
                return jsPsych.data.get().last(1).values()[0].response
            },
            values: ['100', '80', '60', '60', '80', '100'],
            center: '50',
            vertical_center: true,
            vertical: true,
            slider_width: function () {
                return window.screen.width / 4
            },
            adv: function () {
                return Math.random() * 100
            },
            adv_color: jsPsych.timelineVariable('color'),
            stimulus_duration: para.advice_time_trial, // 500 according to SF
        };

        var advisor_accuracy = { // todo: show one line then another?
            type: "image-keyboard-response",
            stimulus: 'img/sil.png',
            adv_color: jsPsych.timelineVariable('color'),
            stimulus_height: function () {
                return window.screen.height / 6 // window object can be called directly
            },
            prompt: function () {
                var advisor = jsPsych.timelineVariable('name', true);
                var accuracy = para.accuracy; // given that the two advisors have the same level of accuracy
                var random = Math.random(); // U ~ [0,1]
                var correct_answer = jsPsych.data.get().last(1).values()[0].direction;
                var wrong_answer = jsPsych.data.get().last(1).values()[0].wrong_direction;
                if (accuracy > random) {
                    var feedback_current_trial = 'correct';
                    var color = para.color_feedback[0];
                    var advisor_answer = correct_answer[0].toUpperCase();
                }
                else {
                    var feedback_current_trial = 'wrong';
                    var color = para.color_feedback[1];
                    var advisor_answer = wrong_answer[0].toUpperCase();

                }
                return "<p><b>" + advisor + "</b> choose <b>" + advisor_answer + "</b>.</p>" +// problem of left and right
                    "<br><p><b>" + advisor + "</b>'s choice was <span style = \"color:" + color + "\"><b>" +
                    feedback_current_trial + "</b></span></p>."
                // TODO: the sequence of display?
            },
            data: { test_part: 'advisor' }
            // save these data?
            // incentive - not deciding right then not proceeding?
        }

        var advisor_accuracy_warmup = { // todo: show one line then another?
            type: "image-keyboard-response",
            stimulus: 'img/sil.png',
            adv_color: jsPsych.timelineVariable('color'),
            stimulus_height: function () {
                return window.screen.height / 6 // window object can be called directly
            },
            prompt: function () {
                var advisor = jsPsych.timelineVariable('name', true);
                var accuracy = para.accuracy_warmup; // given that the two advisors have the same level of accuracy
                var random = Math.random(); // U ~ [0,1]
                var correct_answer = jsPsych.data.get().last(1).values()[0].direction;
                var wrong_answer = jsPsych.data.get().last(1).values()[0].wrong_direction;
                if (accuracy > random) {
                    var feedback_current_trial = 'correct';
                    var color = para.color_feedback[0];
                    var advisor_answer = correct_answer[0].toUpperCase();
                }
                else {
                    var feedback_current_trial = 'wrong';
                    var color = para.color_feedback[1];
                    var advisor_answer = wrong_answer[0].toUpperCase();

                }
                return "<p><b>" + advisor + "</b> choose <b>" + advisor_answer + "</b>.</p>" +// problem of left and right
                    "<br><p><b>" + advisor + "</b>'s choice was <span style = \"color:" + color + "\"><b>" +
                    feedback_current_trial + "</b></span></p>."
                // TODO: the sequence of display?
            },
            data: { test_part: 'advisor' }
            // save these data?
            // incentive - not deciding right then not proceeding?
        }

        /* define instruction_demo for each part */

        var attitude_advisor = { // add their picture here?
            type: "image-keyboard-response",
            stimulus: 'img/sil.png',
            adv_color: jsPsych.timelineVariable('color'),
            stimulus_height: function () {
                return window.screen.height / 6 // window object can be called directly
            },
            prompt: function () {
                var advisor = jsPsych.timelineVariable('name', true);
                return "<p>In this round, <b>" + advisor + "</b> has received $1. </p>" // may need to add pic in the future
            },
            post_trial_gap: 100,
        };



        /* Show advisor's decision in DG */
        var attitude_advisor_decision = {
            type: "image-keyboard-response",
            stimulus: 'img/sil.png',
            adv_color: jsPsych.timelineVariable('color'),
            stimulus_height: function () {
                return window.screen.height / 6 // window object can be called directly
            },
            prompt: function () {
                var advisor = jsPsych.timelineVariable('name', true);
                var current_share_prop_fixed = jsPsych.timelineVariable('share_mean', true);
                var current_share_std_fixed = jsPsych.timelineVariable('share_sd', true);
                var current_share_prop = Math.max(jStat.normal.sample(current_share_prop_fixed, current_share_std_fixed), 0);
                // var current_share = current_share_prop.toFixed(2); // perserve 2 decimal places - not sure why it doesn't work sometime
                var current_share = (Math.floor(current_share_prop * 100) / 100).toFixed(2); // this double insurance seems to fix the toFixed() problem but I am not 100% sure
                var current_keep = (1 - current_share).toFixed(2);
                return "<p><b>" + advisor + "</b> has decided to keep $" + current_keep + " and send $" + current_share + " to you.</p>"
            },
        }

        var joint_decision_trial = { // limited time & no state parameter
            type: "html-keyboard-response",
            stimulus: function () {
                var left = 'L';
                var right = 'R';
                return "<p>" + left + " or " + right + "?</p>"
            },
            choices: jsPsych.timelineVariable('choices'),
            post_trial_gap: 200,
            trial_duration: 1500,
            data: { task: 'decision' },
            on_finish: function (data) {
                if (data.key_press == jsPsych.pluginAPI.convertKeyCharacterToKeyCode(jsPsych.timelineVariable('correct_choice', true))) {
                    data.feedback = 'correct';
                } else {
                    data.feedback = 'wrong';
                }
            }
            //Todo: what if they didn't response in time - show the warning?
        }

        var decision_trial_unlimited = { // limited time & no state parameter
            type: "html-keyboard-response",
            stimulus: function () {
                var left = 'L';
                var right = 'R';
                return "<p>" + left + " or " + right + "?</p>"
            },
            choices: jsPsych.timelineVariable('choices'),
            post_trial_gap: 200,
            data: { task: 'decision' },
            on_finish: function (data) {
                if (data.key_press == jsPsych.pluginAPI.convertKeyCharacterToKeyCode(jsPsych.timelineVariable('correct_choice', true))) {
                    data.feedback = 'correct';
                } else {
                    data.feedback = 'wrong';
                }
            }
            //Todo: what if they didn't response in time - show the warning?
        }

        var advisor_accuracy_comp = {
            type: "html-keyboard-response",
            Choice: ['1', '2', '3'],
            stimulus: function () {
                var order = Math.round(Math.random());
                if (order == 0) {
                    var advisor1 = para.name[0];
                    var advisor2 = para.name[1];
                }
                else {
                    var advisor1 = para.name[1];
                    var advisor2 = para.name[0];
                }
                return "<p> If you think " + advisor1 + " performs better than " + advisor2 + " ,press '1'</p>" +
                    "<p> If you think " + advisor2 + " performs better than " + advisor1 + " ,press '2'</p>" +
                    "<p> If you think they perform equally well, press '3'</p>"
            },
            on_finish: function (data) {
                if (data.key_press == '3') {
                    data.comp = 'equal';
                }
                else {
                    data.comp = 'undecided'; // this needs changing
                }
            },
            trial_duration: 5000,
            response_ends_trial: false,
        }

        // feedback on advisor_accuracy_comp?

        var observe_demo1 = { // two different silhouette - repeat ntimes (the advisor number)
            type: "image-keyboard-response",
            stimulus: 'img/sil.png',
            adv_color: jsPsych.timelineVariable('color'),
            stimulus_height: function () {
                return window.screen.height / 6 // window object can be called directly
            },
            prompt: function () {
                var advisor = jsPsych.timelineVariable('name', true);
                var adv_color = jsPsych.timelineVariable('color', true);
                return "<p> The silhouette with the " + adv_color + " background is " + advisor + ".</p>" +
                    "<p>Press any key to continue</p>"
            },

        }

        var observe_demo2 = {
            type: "image-keyboard-response",
            stimulus: 'img/sil.png',
            adv_color: jsPsych.timelineVariable('color'),
            stimulus_height: function () {
                return window.screen.height / 6 // window object can be called directly
            },
            prompt: function () {
                var advisor_answer = jsPsych.timelineVariable('advisor_answer', true)
                var advisor = jsPsych.timelineVariable('name', true);
                var feedback_current_trial = jsPsych.timelineVariable('feedback', true);
                if (feedback_current_trial == "correct") {
                    var color = para.color_feedback[0];
                }
                else {
                    var color = para.color_feedback[1];
                }
                return "<p><b>" + advisor + "</b> choose <b>" + advisor_answer + "</b>.</p>" +// problem of left and right
                    "<br><p><b>" + advisor + "</b>'s choice was <span style = \"color:" + color + "\"><b>" +
                    feedback_current_trial + "</b></span></p>."
            },
        }

        /* define real experiment phases */
        // response time is unlimited here
        // each array in the timeline_variable will be used (not use just one)

        // note that the feedback_trial is still in debug mode here
        var calibrate_start_procedure = {
            timeline: [test_trial_first, decision_trial, feedback_trial_debug], // put feedback after confidence_rating lol
            timeline_variables: calibrate_stimuli, // not just choose one but all of them!
            repetitions: 1, // 0 or 1 means no repetition. 
            randomize_order: true,
            data: { phase: 'calibrate_start' }
            // Todo: save data after each trial?
        }

        var calibrate_procedure = {
            timeline: [test_trial, decision_trial, feedback_trial_debug], // put feedback after confidence_rating lol
            timeline_variables: calibrate_stimuli,
            repetitions: para.calibrate_rep, // (70-2)/2. when debugging, just to make sure the total is more than 25
            randomize_order: true,
            data: { phase: 'calibrate_real' }
            // Todo: save data after each trial?
        }

        // It took me so long to debug the last 25 trials calculation...
        var calibrate_block = {
            timeline: [calibrate_start_procedure, calibrate_procedure, end_of_task],
            repetitions: 1,
            on_finish: function (data) {
                var coherence_prev_all = jsPsych.data.get().filter({ feature: 'normal_coherence' }).select('coherence').values;
                var range = para.threshold_cal_range; // usually 25
                var threshold_cal = jStat.mean(coherence_prev_all.slice(coherence_prev_all.length - range));
                var perform_prev_all = jsPsych.data.get().filter({ task: 'decision' }).select('feedback').values;
                var correct_count = 0;
                for (i = perform_prev_all.length - range; i < perform_prev_all.length; i += 1) {
                    if (perform_prev_all[i] == "correct") {
                        correct_count += 1;
                    }
                }
                var correct_avg = correct_count / range;
                jsPsych.data.addProperties({ threshold: threshold_cal, accuracy: correct_avg }); // will add to each trial
                // para.threshold = jsPsych.data.get().select('threshold').mean();
                para.threshold = threshold_cal;
                para.accuracy = correct_avg;
                // I think I have achieved my goal but still not sure how many times the console.log will carry out (definitely not just once)
            }
            // I dont know whether I need randomize_order here
            // and I don't think I care about the phase order
        }

        // define scales

        var scale_feeling = [ // 5 point likert scale?
            "Very Negative",
            "Negative",
            "Neutral",
            "Positive",
            "Strong Positive"
        ]

        var likert_feeling = {
            type: 'survey-likert',
            questions: [
                { prompt: "How do you feel now?", labels: scale_feeling }
                // or I should use a VAS? - Oriel use 5 points
            ]
        }

        var scale_trait = [
            "not al all",
            "",
            "",
            "",
            "extreme"
        ]
        var likert_1 = {
            type: 'survey-likert',
            questions: [
                    { prompt: "How trustworthy do you think this advisor is?",
                    labels: scale_trait }
            ],
            stimulus: 'img/sil.png',
            stimulus_height: function () {
                return window.screen.height / 6
            },
            adv_color: jsPsych.timelineVariable('color'),

        }

        // var confidence_rating_1_adv = {
        //     type: "image-slider-response-adv",
        //     stimulus: 'img/sil.png',
        //     stimulus_height: function () {
        //         return window.screen.height / 6
        //     },
        //     labels: ['LEFT', 'RIGHT'],
        //     start: function () {
        //         return jsPsych.data.get().last(1).values()[0].response
        //     },
        //     values: ['100', '80', '60', '60', '80', '100'],
        //     center: '50',
        //     vertical_center: true,
        //     vertical: true,
        //     slider_width: function () {
        //         return window.screen.width / 4
        //     },
        //     adv: function () {
        //         return Math.random() * 100
        //     },
        //     adv_color: jsPsych.timelineVariable('color'),
        //     stimulus_duration: para.advice_time_trial, // 500 according to SF
        // };

        var likert_2 = {
            type: 'survey-likert',
            questions: [

                    { prompt: "How accurate do you think this advisor is?",
                    labels: scale_trait }
            ],
            stimulus: 'img/sil.png',
            stimulus_height: function () {
                return window.screen.height / 6
            },
            adv_color: jsPsych.timelineVariable('color'),
        }

        var likert_3 = {
            type: 'survey-likert',
            questions: [
            { prompt: "How confident do you think this advisor is?",
                    labels: scale_trait }
            ],
            stimulus: 'img/sil.png',
            stimulus_height: function () {
                return window.screen.height / 6
            },
            adv_color: jsPsych.timelineVariable('color'),
        }

        var likert_4 = {
            type: 'survey-likert',
            questions: [
                { prompt: "How likeable do you think this advisor is?",
                    labels: scale_trait }
            ],
            stimulus: 'img/sil.png',
            stimulus_height: function () {
                return window.screen.height / 6
            },
            adv_color: jsPsych.timelineVariable('color'),
        }

        var likert_5 = {
            type: 'survey-likert',
            questions: [
            { prompt: "How influential do you think this advisor is to your decisions?",
                    labels: scale_trait }
            ],
            stimulus: 'img/sil.png',
            stimulus_height: function () {
                return window.screen.height / 6
            },
            adv_color: jsPsych.timelineVariable('color'),
        }

        // todo: reconcile phase, feature, task

        var fixed_stimuli = [
            { coherent_direction: 0, choices: para.choices, correct_choice: para.choices[1], coherence: para.threshold, data: { task: 'confidence', direction: 'right', wrong_direction: 'left' } }, //right
            { coherent_direction: 180, choices: para.choices, correct_choice: para.choices[0], coherence: para.threshold, data: { task: 'confidence', direction: 'left', wrong_direction: 'right' } }, //left,
        ];

        var advisor_stimuli = [
            { coherent_direction: 0, choices: para.choices, correct_choice: para.choices[1], coherence: para.threshold, name: para.name[0], accuracy: para.accuracy, color: para.color[0], data: { test_part: 'advisor', direction: 'right', wrong_direction: 'left' } }, //right
            { coherent_direction: 180, choices: para.choices, correct_choice: para.choices[0], coherence: para.threshold, name: para.name[0], accuracy: para.accuracy, color: para.color[0], data: { test_part: 'advisor', direction: 'left', wrong_direction: 'right' } }, //left
            { coherent_direction: 0, choices: para.choices, correct_choice: para.choices[1], coherence: para.threshold, name: para.name[1], accuracy: para.accuracy, color: para.color[1], data: { test_part: 'advisor', direction: 'right', wrong_direction: 'left' } }, //right
            { coherent_direction: 180, choices: para.choices, correct_choice: para.choices[0], coherence: para.threshold, name: para.name[1], accuracy: para.accuracy, color: para.color[1], data: { test_part: 'advisor', direction: 'left', wrong_direction: 'right' } }, //left
        ]

        var attitude_stimuli = [
            { name: para.name[0], color: para.color[0], share_mean: 0.8, share_sd: 0.1, choices: para.choices },
            { name: para.name[1], color: para.color[1], share_mean: 0.2, share_sd: 0.1, choices: para.choices },
        ]

        var calibrate_demo = {
            timeline: [calibrate_instructions1, calibrate_demo1,
                calibrate_instructions2, calibrate_demo2,
                calibrate_instructions3, calibrate_demo3,
                calibrate_instructions4, calibrate_demo4,
                calibrate_instructions5, calibrate_demo5, calibrate_demo_decision5, //actually I need to record response here
                calibrate_instructions6],
            // no timeline variable here?
        }

        var confidence_practice = { // very similar to confidence_procedure, just change the timeline_variables
            timeline: [test_trial_threshold, decision_trial_unlimited, confidence_rating_1_pic],
            timeline_variables: practice_stimuli,
            repetitions: 1, // may want to change it in the future
            randomize_order: true
        }

        var confidence_demo = {
            timeline: [confidence_instructions1, confidence_demo1_2,
                confidence_instructions2, confidence_demo1_2,
                confidence_instructions3, confidence_demo3_1_1, confidence_demo3_1_2,
                confidence_demo3_2_1, confidence_demo3_2_2,
                confidence_demo3_3_1, confidence_demo3_3_2,
                confidence_instructions4, confidence_practice,
                confidence_instructions5],
            repetitions: 1, // 0 or 1 means no repetition. 
            randomize_order: true,
        }

        var advisor_accuracy_demo_part1 = {
            timeline: [observe_demo1],
            timeline_variables: advisor_stimuli_demo1,
            randomize_order: true,
        }

        var advisor_accuracy_demo_part2 = {
            timeline: [observe_demo2],
            timeline_variables: advisor_stimuli_demo2,
            randomize_order: true,
        }

        var advisor_accuracy_practice = { // _comp doesn't need to be shown multiple times
            timeline: [test_trial_threshold, advisor_accuracy_warmup],
            timeline_variables: advisor_stimuli, // 4 in total now
            repetitions: 1,
            randomize_order: true,
        }

        var advisor_accuracy_demo = {
            timeline: [observe_instructions1, advisor_accuracy_demo_part1,
                observe_instructions2, advisor_accuracy_demo_part2,
                advisor_accuracy_practice, advisor_accuracy_comp,
                observe_instructions4],
        }

        var attitude_practice = {
            timeline: [attitude_advisor, attitude_advisor_decision, likert_feeling],
            timeline_variables: attitude_stimuli, // 2 in total
            repetitions: 2, // arbitrary num here
            randomize_order: true
        }

        var attitude_demo = {
            timeline: [attitude_instructions1,
                attitude_instructions2,
                attitude_instructions3, attitude_practice,
                attitude_instructions4],
        }

        var confidence_procedure = {
            timeline: [test_trial_threshold, decision_trial_unlimited, confidence_rating_1_pic],
            timeline_variables: fixed_stimuli,
            repetitions: para.confidence_rep,
            randomize_order: true
        }


        /* Display each round advisor's choice and attention check*/
        // question: how to add attention check?

        /* **define phase here?** integrate fixation, test_trial, advisor_name, advisor_accuracy into one object */
        var advisor_accuracy_procedure = {
            timeline: [test_trial_threshold, advisor_accuracy], //advisor_name is temporarily eliminated 
            timeline_variables: advisor_stimuli,
            repetitions: para.advisor_accuracy_rep,
            randomize_order: true
            // Q: is it really necessary to let the participants see the dots moving? Let them make a comparison with themselves?
            // todo: how to write the instructions
            // todo: show them their overall accuracy level?
        }

        var advisor_accuracy_block = {
            timeline: [advisor_accuracy_procedure, advisor_accuracy_comp],
            randomize_order: true,
        }

        /* **Subject to change** Advisor Rating */
        /* attitude induction phase instruction*/
        var rate_instructions = {
            type: "html-keyboard-response",
            stimulus: "<p>Now please rate the two participants you have encountered</p>" +
                "<p>in this experiment on the following questions.</p>"+
                "<p>Press any key to continue.</p>",
            post_trial_gap: 500
        };

        var rate_instructions_advisor = {
            type: "image-keyboard-response",
            prompt: function () {
                var advisor = jsPsych.timelineVariable('name', true);
                return "<p>Please rate " + advisor + " on the following questions.</p>" +
                    "<p>Press any key to continue.</p>"
            },
            post_trial_gap: 500,
            stimulus: 'img/sil.png',
            stimulus_height: function () {
                return window.screen.height / 6
            },
            adv_color: jsPsych.timelineVariable('color'),
        };

        var rate_advisor = {
            timeline: [rate_instructions_advisor, likert_1, likert_2, likert_3, likert_4, likert_5],
            timeline_variables: advisor_stimuli,
            randomize_order: true,
            // show them on the same screen?
        }

        var rate_procedure = {
            timeline: [rate_instructions, rate_advisor]
        }

        /* integrate the whole attitude thing into one object */
        var attitude_procedure = {
            timeline: [attitude_advisor, attitude_advisor_decision, likert_feeling],
            timeline_variables: attitude_stimuli, // 2 in total
            repetitions: para.attitude_rep,
            randomize_order: true
        }

        var joint_example = {
            timeline: [test_trial_threshold, joint_decision_trial, confidence_rating_1_pic, confidence_rating_1_adv,
            ],
            timeline_variables: advisor_stimuli, // 4 in total (two directions, 2 advisor)
            sample: {
                type: 'with-replacement',
                size: 1,
            }
        }

        var joint_practice = {
            timeline: [test_trial_threshold, joint_decision_trial, confidence_rating_1_pic, confidence_rating_1_adv,
            ],
            timeline_variables: advisor_stimuli, // 4 in total (two directions, 2 advisor)
            sample: {
                type: 'with-replacement',
                size: 6,
            }
        }



        var joint_demo = {
            timeline: [joint_instructions1, joint_demo1,
                joint_instructions2, joint_demo2,
                joint_instructions3, joint_demo3,
                joint_instructions4, joint_example,
                joint_instructions5, joint_practice,
                joint_instructions6]
        }

        var joint_procedure = {
            timeline: [test_trial_threshold, joint_decision_trial, confidence_rating_1_pic, confidence_rating_1_adv, // may need to add adv name?
            ],
            timeline_variables: advisor_stimuli, // 4 in total (two directions, 2 advisor)
            repetition: para.joint_rep,
            randomize_order: true,
            data: { phase: 'joint' }
        }

        /* advisor characteristic has been defined */

        // push everything at the same time
        //timeline.push(welcome); // distinguish between procedure and block lol

        // timeline.push(calibrate_demo);
        // timeline.push(calibrate_block);

        // timeline.push(confidence_demo);
        // timeline.push(confidence_procedure); // - previous problem is due to the order of claim variables

        // timeline.push(advisor_accuracy_demo);
        // timeline.push(advisor_accuracy_block); // which is the observe_block

        // timeline.push(rate_instructions) // rate1
        timeline.push(rate_procedure)

        // timeline.push(attitude_demo)
        // timeline.push(attitude_procedure) // also the color for this thing

        //timeline.push(rate_instructions) // rate2
        // timeline.push(rate_procedure)

        // timeline.push(joint_demo)
        // timeline.push(joint_procedure)

        //timeline.push(rate_instructions) // rate3
        //timeline.push(rate_procedure) 

        //timeline.push(farewell)


        /* start the experiment */
        jsPsych.init({
            timeline: timeline,
            on_finish: function () {
                jsPsych.data.displayData();
            }
        });
    </script>

</html>